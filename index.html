<!doctype html>
<html lang="en">
 <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>Packer</title>
   <script src="lib/dat.gui.min.js"></script>
   <script src="lib/clipper.js"></script>
   <style>
    body { color: #ccc; background-color: #111; }
    svg * { fill: #666; stroke: #999; }
   </style>
 </head>
 <body>
  <div id="input"></div>
  <div id="result"></div>
  <script type="module">
  import { Packer } from './packer.js'
  import { Generator } from './lib/polygonGenerator.js'
  import { datGUIProgress } from './lib/dat.gui.progress.js'

  const NS = 'http://www.w3.org/2000/svg'
  const SVG = (polygons) => {
    const svg = document.createElementNS(NS, 'svg')
    polygons.forEach((points) => {
      const n = document.createElementNS(NS, 'polygon')
      n.setAttribute('points', points.map((p) => `${p.x},${p.y}`).join(' '))
      svg.appendChild(n)
    })
    return svg
  }

  const gui = new dat.GUI()
  const packer = new Packer()
  const generator = new Generator()
  const result = document.getElementById('result')
  const progress = new datGUIProgress(gui.addFolder('progress'))
  const display = { el: document.getElementById('input'), svg: null }

  const configFolder = gui.addFolder('config')
  configFolder.add(packer, 'width', 0, 600)
  configFolder.add(packer, 'height', 0, 600)
  configFolder.add(packer, 'spacing', 0, 10)
  configFolder.add(packer, 'rotations', 1, 8, 1)

  const genFolder = gui.addFolder('generator')
  genFolder.add(generator, 'count', 3, 50, 1)
  genFolder.add(generator, 'scaleMin', 10, 200)
  genFolder.add(generator, 'scaleRange', 10, 100)
  genFolder.add(generator, 'shape', generator.shapes)

  const chooseParts = (parts) => {
    packer.load(parts)
    display.svg = SVG(parts)
    display.el.innerHTML = ''
    display.el.appendChild(display.svg)
    result.innerHTML = ''
  }

  const showResult = (packed) => {
    if (!packed) return
    progress.hide()
    progress.remove()
    const clone = [...display.svg.childNodes].map((n) => n.cloneNode(false))
    result.innerHTML = ''
    packed.bins.forEach((bin) => {
      const ns = display.svg.cloneNode(false)
      ns.setAttribute('width', `${packer.width}px`)
      ns.setAttribute('height', `${packer.height}px`)
      ns.setAttribute('viewBox', `0 0 ${packer.width} ${packer.height}`)
      bin.forEach((p) => {
        const g = document.createElementNS(NS, 'g')
        g.setAttribute('transform', p.transform)
        g.appendChild(clone[p.id])
        ns.appendChild(g)
      })
      result.appendChild(ns)
    })
  }

  const menu = {
    sample: '',
    pack: () => {
      progress.show()
      packer.start((v) => progress.on(v)).then(showResult)
    },
    generate: () => chooseParts(generator.generate())
  }

  const testPacks = {
    test: [
      [{x: 1, y: 1}, {x: 23, y: 0}, {x: 40, y: 20}],
      [{x: 3, y: 20}, {x: 12, y: 11}, {x: 54, y: 30}],
      [{x: 90, y: 80}, {x: 41, y: 30}, {x: 20, y: 50}],
    ],
    rect: [
      [{x: 1, y: 1}, {x: 23, y: 1}, {x: 23, y: 20}, {x: 1, y: 20}],
      [{x: 3, y: 20}, {x: 12, y: 20}, {x: 12, y: 30}, {x: 3, y: 30}],
      [{x: 41, y: 80}, {x: 41, y: 30}, {x: 20, y: 30}, {x: 20, y: 80}],
    ],
  }

  gui.add(menu, 'generate')
  gui.add(menu, 'sample', Object.keys(testPacks)).onChange((v) => chooseParts(testPacks[v]))
  gui.add(menu, 'pack')

  menu.generate()
  </script>
 </body>
</html>
